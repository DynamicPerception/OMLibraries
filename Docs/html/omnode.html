<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OpenMoCo AVR Libraries: Creating MoCoBus Node Devices</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenMoCo AVR Libraries
   </div>
   <div id="projectbrief">Motion Control and MoCoBus Libraries for the AVR Platform</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('omnode.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Creating MoCoBus Node Devices </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Creating a new device to live on a MoCoBus network is simple using the <a class="el" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> library. You only have to determine how to handle the commands you receive, the underlying libraries handle all the necessary functionality to route only commands intended for your device to you and allow you to respond back to masters with the information you choose.</p>
<h1><a class="anchor" id="nodeaddr"></a>
Node Address</h1>
<p>Each node on a bus must have a unique address, in this way the bus master may direct commands to specific nodes. You must specify the device address when constructing an <a class="el" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> object.</p>
<p>An <a class="el" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> will only handle commands issued to its address. All other commands will be safely ignored. You may change the address at any time by calling the address() method, and the change will be immediately effective.</p>
<p>There are 254 possible addresses for you to choose from - ranging from 2-255. The addresses 0 and 1 are reserved by the protocol.</p>
<p>Remember that a master on the bus may change your node's address at any time, for information on how to detect and handle this, see the section <a class="el" href="omnode.html#nodeaddrchg">Address Changes for Nodes</a> below.</p>
<h1><a class="anchor" id="nodeident"></a>
Identifying Your Device</h1>
<p>Your node must identify its self when asked, so that a master may understand what type of device it is speaking to. The node library will send this response for you when needed, but you must first specify the correct information.</p>
<p>The <a class="el" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> constructor allows you to specify two identifying pieces of information about your node: a device identifier, and a device version.</p>
<p>A device identifier is an 8 character string that gives the device a unique name. This is used to differentiate types of devices, such as a motor axis or an intervalometer, so that a master may know what commands the device supports.</p>
<p>The device version is a numeric version number for a device type. It is used to differentiate the capabilities of two versions of a specific device. For example, you may add a new command to a device you've already created and have been using. After adding this command, increasing the version number allows you to configure a master to only send the new command to devices having the higher version number, preventing an error when interacting with older devices.</p>
<p>Please note that the device identifier must be exactly 8 characters in length, and any characters outside of the lower-ASCII set will be converted to the character '0' (numeric value 48).</p>
<h1><a class="anchor" id="nodecreate"></a>
Creating a Device</h1>
<p>To create a device, we'll need to create an instance of the <a class="el" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> class and specify some information about our device:</p>
<div class="fragment"><div class="line">    <span class="comment">// note: you -must- include OMMoCoBus.h before including OMMoCoNode.h</span></div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">#include &quot;OMMoCoBus.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;OMMoCoNode.h&quot;</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// RS-485 driver enable pin</span></div>
<div class="line"><span class="preprocessor">#define DE_PIN 5</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> <span class="comment">// device address</span></div>
<div class="line">byte devAddr = 10;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// device identifiers</span></div>
<div class="line"><span class="keywordtype">char</span> devId[]  = <span class="stringliteral">&quot;MyDevice&quot;</span>;</div>
<div class="line"><span class="keywordtype">int</span> devVer    = 1;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// initialize node</span></div>
<div class="line"><a class="code" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> Node = <a class="code" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a>(Serial, DE_PIN, devAddr, devVer, devId);</div>
<div class="line">  </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">        Serial.begin(OM_SER_BPS);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that in the above example, we have to use Serial.begin() before we attempt to use the node. The constant OM_SER_BPS has been defined for you as a convienence, you should use this unless you really need to change the speed of your bus.</p>
<p>Now that we have created a device, we'll need to specify how to handle commands.</p>
<h1><a class="anchor" id="nodecomm"></a>
Receiving and Processing Commands</h1>
<p>The primary method for handling commands sent to your device, is to use a callback function. This function will be called whenever a command is received for your device, passing along the command id and the data received.</p>
<p>What command IDs and data expected with those commands to receive are up to you. Commands are specified as a single byte or char, and their data may take on any form, including a string. The only limitation is that the data for one command must be no more than 32 bytes in length.</p>
<p>Registering a callback allows you to define a function that will handle the commands sent by a master on the bus, and this function will be called as needed by the check() method. You should call the check() method as appropriate in the normal execution of your program to see if a command has arrived and process it.</p>
<p>The following example expands on the previous section to specify the callback handler:</p>
<div class="fragment"><div class="line">    <span class="comment">// note: you -must- include OMMoCoBus.h before including OMMoCoNode.h</span></div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">#include &quot;OMMoCoBus.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;OMMoCoNode.h&quot;</span></div>
<div class="line"></div>
<div class="line"> <span class="comment">// RS-485 driver enable pin</span></div>
<div class="line"><span class="preprocessor">#define DE_PIN 5</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"> <span class="comment">// device address</span></div>
<div class="line">byte devAddr = 10;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// device identifiers</span></div>
<div class="line"><span class="keywordtype">char</span> devId[]  = <span class="stringliteral">&quot;MyDevice&quot;</span>;</div>
<div class="line"><span class="keywordtype">int</span> devVer    = 1;</div>
<div class="line"></div>
<div class="line"> <span class="comment">// initialize node</span></div>
<div class="line"><a class="code" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> Node = <a class="code" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a>(Serial, DE_PIN, devAddr, devVer, devId);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">        Serial.begin(OM_SER_BPS);</div>
<div class="line">        Node.<a class="code" href="class_o_m_mo_co_node.html#aa6cb6e4afb626636d080b6d1799bcd50">setHandler</a>(myHandler);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line"></div>
<div class="line">                <span class="comment">// check for a new command and process</span></div>
<div class="line">                <span class="comment">// as needed</span></div>
<div class="line">                </div>
<div class="line">        Node.<a class="code" href="class_o_m_mo_co_node.html#a1c69fdbee058f70035fc29a22b53f5a8">check</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> myHandler(byte command, byte* comData) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span>(command) {</div>
<div class="line">                <span class="keywordflow">case</span> 2:</div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        </div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        </div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                        </div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                </div>
<div class="line">                        <span class="comment">// unknown command</span></div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">false</span>);</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The check() method is called in the main loop, if a command is received and it is destined for this node, the callback myHandler() is executed. For commands required by the protocol, such as version or identifier information, these are handled automatically by the node library, and you do not need to do anything for them to be handled properly.</p>
<p>Note that in the above example, our callback gets two arguments: A single byte command code, and a pointer to an array of data bytes. The command code is a single byte which specifies the command being sent to you. Only 254 possible codes (2-255) are available for your use, so for more complex command sets you may wish to create sub-commands by putting them in the first part of the data. Codes 0 and 1 are reserved to the core protocol and will never be received by your callback.</p>
<p>In our example, we show that command codes can be expressed either as numeric values or as single characters - since both can be represented in a single byte.</p>
<p>As you are the one that defines what commands your device receives, you also will know the amount and type of the data you will expect in addition to the commands and therefore can implement the processing of that data directly. Remember that you can receive up to 32 bytes of data. If you wish to know how much data was sent to your command, see the bufferLen() method.</p>
<p>You must take care that the data you expect to receive cannot contain a sequence of bytes that matches the break sequence in the protocol (five nulls followed by a single byte with the value 255). You must pad values if passing multiple binary values to preven this from occuring.</p>
<p>Every command issued to your device must get a response as quickly as possible. Therefore, you should never perform a long-running, blocking action when processing a command. If your response takes too long, the master will likely time out your response and handle the situation as an error.</p>
<h1><a class="anchor" id="noderesp"></a>
Sending Responses</h1>
<p>A response must be sent to the master as soon as possible after receiving a command. This response must indicate whether the command was successfully handled, and any data that needs to be transported with the response.</p>
<p>There are two codes, true or false, which are available to you. True indicates that the command was successful, and false that the command in some way failed (e.g.: the command was unknown).</p>
<p>The <a class="el" href="class_o_m_mo_co_node.html" title="MoCoBus Node Library.">OMMoCoNode</a> library allows you to send nearly any basic type of data as a response to a master, and in addition you can also send a string of a specified length as a response. The underlying mechanisms ensure this data is transmitted in a way that the master can understand.</p>
<p>The following example shows a callback handler that sends three types of data, a single-byte, a floating point integer, and a string:</p>
<div class="fragment"><div class="line"> <span class="keywordtype">void</span> myHandler(byte command, byte* comData) {</div>
<div class="line"></div>
<div class="line">        byte foo = 1;</div>
<div class="line">        <span class="keywordtype">float</span> bar = 3.25;</div>
<div class="line">        <span class="keywordtype">char</span> baz[] = <span class="stringliteral">&quot;OK&quot;</span>;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">switch</span>(command) {</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:</div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>, foo);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>, bar);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>, <span class="stringliteral">&quot;OK&quot;</span>, 2);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                        </div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                </div>
<div class="line">                        <span class="comment">// unknown command</span></div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">false</span>);</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p>As we can see from the example, string responses require a length so that the unlderying libraries can transport the data properly.</p>
<h1><a class="anchor" id="nodedata"></a>
Processing Data</h1>
<p>Of course, lots of commands we might receive will come with additional data about how to process them. As all multi-byte data sent using the mocobus protocol is in big-endian order, you can either re-pack the bytes manually, or simply use the provided helper functions: ntoi(), ntoui(), ntol(), ntoul(), and ntof(), covering integers, unsigned integers, longs, unsigned longs, and floats respectively.</p>
<div class="fragment"><div class="line"> <span class="keywordtype">void</span> myHandler(byte command, byte* comData) {</div>
<div class="line"></div>
<div class="line">        byte foo = 1;</div>
<div class="line">        <span class="keywordtype">float</span> bar = 3.25;</div>
<div class="line">        <span class="keywordtype">char</span> baz[] = <span class="stringliteral">&quot;OK&quot;</span>;</div>
<div class="line">        </div>
<div class="line">        byte speed = 0;</div>
<div class="line">        <span class="keywordtype">int</span> dist = 0;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">switch</span>(command) {</div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:</div>
<div class="line">                        <span class="comment">// accept a single byte of data</span></div>
<div class="line">                        </div>
<div class="line">                        speed = comData[0];</div>
<div class="line"></div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        </div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>, foo);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                        </div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div>
<div class="line">                        <span class="comment">// accept an unsigned integer</span></div>
<div class="line">                        </div>
<div class="line">                        dist = Node.<a class="code" href="class_o_m_mo_co_bus.html#a7a90d267a7a21c886b93b58f247d4f4c">ntoui</a>(comData);</div>
<div class="line">                        </div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        </div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>, bar);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">                        <span class="comment">// do something</span></div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>, baz, 2);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                        </div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                </div>
<div class="line">                        <span class="comment">// unknown command</span></div>
<div class="line">                        Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">false</span>);</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Should we want to accept strings up to 31 characters in length, we can simply re-cast the pointer to the byte array to a pointer to a character array. If doing this, you must ensure the strings are null-terminated.</p>
<p>e.g.:</p>
<div class="fragment"><div class="line">  <span class="keywordtype">char</span>* foo;</div>
<div class="line">  </div>
<div class="line">  ...</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:</div>
<div class="line">        <span class="comment">// get string from data</span></div>
<div class="line">        foo = (<span class="keywordtype">char</span>*) comData;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span>( foo == <span class="stringliteral">&quot;left&quot;</span> || foo == <span class="stringliteral">&quot;right&quot;</span> ) {</div>
<div class="line">                Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">true</span>, <span class="stringliteral">&quot;OK&quot;</span>, 2);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">                Node.<a class="code" href="class_o_m_mo_co_node.html#ae83ba323f19fde07537d82792cb21a4d">response</a>(<span class="keyword">false</span>, <span class="stringliteral">&quot;Wrong Dir&quot;</span>, 9);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">break</span>;</div>
</div><!-- fragment --><p>Now, we have all of the core elements together to create our own device types, and manage nodes on a network.</p>
<h1><a class="anchor" id="nodebcast"></a>
Handling Broadcast Commands</h1>
<p>The MoCoBus protocol allows for broadcast packets to be received by all nodes. Such packets are normally used to synchronize activities, timing, or other functionality on the bus. Broadcast packets are identified by being directed to a specific address, which is defined by OM_SER_BCAST_ADDR.</p>
<p><b>You must never send a response to a broadcast packet - doing so will result in bus contention or collisions, resulting in bus instability.</b></p>
<p>There are a small set of "basic" broadcast packet codes which have been pre-defined as part of the MoCoBus protocol, as they are likely to be used by many node types, they are specified using the following defined values:</p>
<p>OM_BCAST_START </p>
<pre class="fragment">  To be interpreted as a start command
</pre><p>OM_BCAST_STOP </p>
<pre class="fragment">  To be interpreted as a stop command
</pre><p>OM_BCAST_PAUSE </p>
<pre class="fragment">  To be interpreted as a pause command
</pre><p>If your node can receive and handle broadcast commands, you will need to specify a broadcast handler. If you do not specify a broadcast handler, no callback handler will be executed on a broadcast command, and your node will ignore it.</p>
<p>The following code provides an example of handling a broadcast command in an Arduino sketch:</p>
<div class="fragment"><div class="line">  <span class="keywordtype">void</span> setup() {</div>
<div class="line">        ...</div>
<div class="line">        Node.<a class="code" href="class_o_m_mo_co_node.html#ae1407f1b00bfecd7911b205867a85dfc">setBCastHandler</a>(broadcast);</div>
<div class="line">        ...</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordtype">void</span> broadcast(byte code, byte* data) {</div>
<div class="line">  </div>
<div class="line">        <span class="keywordflow">switch</span>(code) {</div>
<div class="line">        </div>
<div class="line">                <span class="keywordflow">case</span> OM_BCAST_START:</div>
<div class="line">                        do_start();</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">case</span> OM_BCAST_STOP:</div>
<div class="line">                        do_stop();</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                        </div>
<div class="line">                <span class="keywordflow">case</span> OM_BCAST_PAUSE:</div>
<div class="line">                        do_pause();</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                </div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Note that broadcast packets may contain packet data like any normal packet. To prevent collision between different node types and the broadcast commands they accept, it is suggested to add a definition for any broadcast commands you create to <a class="el" href="_o_m_mo_co_defs_8h_source.html">OMMoCoDefs.h</a> and submit it back to the community for public acceptance.</p>
<h1><a class="anchor" id="nodeaddrchg"></a>
Address Changes for Nodes</h1>
<p>The MoCoBus protocol specifies an address change command as part of the core command set which all devices must recognize. This library handles all such commands for you. However, one of the core commands every device must recognize is the change address command.</p>
<p>For many devices, saving the address between power cycles is necessary for a good user experience. However, since the address of your particular node can be changed without your involvement, you will need a way to know about the change so that you may trigger your action.</p>
<p>The node library provides such a way for you. The method addressCallback() allows you to specify a callback which will be executed every time the address for your node is changed - no matter the source of the change. The specified callback method must accept a single byte argument (the new address) and return void. The following is an example of handling address changes:</p>
<div class="fragment"><div class="line">  ...</div>
<div class="line">  </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">        Serial.begin(OM_SER_BPS);</div>
<div class="line">        Node.<a class="code" href="class_o_m_mo_co_node.html#aa6cb6e4afb626636d080b6d1799bcd50">setHandler</a>(myHandler);</div>
<div class="line">        Node.<a class="code" href="class_o_m_mo_co_bus.html#a577164df79b2be053269fb0729fce5be">addressCallback</a>(myAddrChange);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> myAddrChange(byte p_addr) {</div>
<div class="line">  <span class="comment">// a new address was assigned to the node</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// do something with the new address, like save to eeprom</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">...</div>
</div><!-- fragment --><p>With the above addition, we now have a callback which will execute an action whenever the address is changed.</p>
<p>Of course, you may also choose to change the address of your node - this can be accomplished using the address() method.</p>
<h1><a class="anchor" id="nodebcast"></a>
Handling Broadcast Commands</h1>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Feb 12 2013 09:16:38 for OpenMoCo AVR Libraries by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.1 </li>
  </ul>
</div>
</body>
</html>
